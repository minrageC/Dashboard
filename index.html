<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plano Diário</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { box-sizing: border-box; }
  .num { font-variant-numeric: tabular-nums; }
  table { border-collapse: collapse; }
  th, td { border-bottom: 1px solid #e5e7eb; }
  .sticky-th { position: sticky; top: 0; background: white; box-shadow: 0 1px 0 #e5e7eb; z-index: 1; }
  .win { background-color: #d1fae5 !important; color: #065f46; font-weight: bold; }
  .loss { background-color: #fee2e2 !important; color: #b91c1c; font-weight: bold; }
  .clickable { cursor: pointer; text-align: center; border-radius: 0.5rem; padding: 0.25rem; }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<main class="max-w-6xl mx-auto p-4 md:p-8">

<header class="mb-6">
<h1 class="text-2xl md:text-3xl font-bold">Plano diário</h1>
<p class="text-sm text-gray-600">Período: <span id="periodo" class="font-medium">
  
</span> • Dias (inclusivos): <span id="dias" class="font-medium num"></span></p>
</header>

<section class="grid md:grid-cols-2 gap-4 mb-6">
<div class="bg-white rounded-2xl shadow p-4 md:p-6 space-y-4">
<h2 class="text-lg font-semibold">Parâmetros</h2>
<div class="grid grid-cols-2 gap-3">
<label class="text-sm">Banca inicial (MZN)
<input id="banca" type="number" class="w-full mt-1 rounded-xl border p-2 num" value="2000" min="1">
</label>
<label class="text-sm">Meta final (MZN)
<input id="meta" type="number" class="w-full mt-1 rounded-xl border p-2 num" value="300000" min="1">
</label>
<label class="text-sm">Início
<input id="inicio" type="date" class="w-full mt-1 rounded-xl border p-2" value="2025-09-01">
</label>
<label class="text-sm">Fim
<input id="fim" type="date" class="w-full mt-1 rounded-xl border p-2" value="2026-01-31">
</label>
<label class="text-sm">Stop-loss diário (% da banca)
<input id="slPct" type="number" class="w-full mt-1 rounded-xl border p-2 num" value="2.5" step="0.1">
</label>
<label class="text-sm">Stop-win diário (% da banca)
<input id="swPct" type="number" class="w-full mt-1 rounded-xl border p-2 num" value="5" step="0.1">
</label>
</div>
<div class="flex gap-2">
<button id="recalcular" class="px-4 py-2 rounded-xl bg-black text-white shadow">Recalcular</button>
<button id="exportar" class="px-4 py-2 rounded-xl bg-gray-800 text-white shadow">Exportar CSV</button>
<button id="imprimir" class="px-4 py-2 rounded-xl bg-gray-200 shadow">Imprimir</button>
</div>
</div>

<div class="bg-white rounded-2xl shadow p-4 md:p-6 space-y-3">
<h2 class="text-lg font-semibold">Resumo (Dia 1)</h2>
<div class="grid grid-cols-2 gap-3 text-sm">
<div class="p-3 rounded-xl bg-gray-50">
<div class="text-gray-500">Crescimento diário necessário</div>
<div class="text-xl font-bold num" id="rPct">—</div>
</div>
<div class="p-3 rounded-xl bg-gray-50">
<div class="text-gray-500">Stop-loss (Dia 1)</div>
<div class="text-xl font-bold num"><span id="slValor">—</span> MZN</div>
</div>
<div class="p-3 rounded-xl bg-gray-50">
<div class="text-gray-500">Stop-win (Dia 1)</div>
<div class="text-xl font-bold num"><span id="swValor">—</span> MZN</div>
</div>
</div>
</div>
</section>

<section class="bg-white rounded-2xl shadow overflow-hidden">
<div class="px-4 py-3 flex items-center justify-between">
<h2 class="text-lg font-semibold">Evolução diária (plano composto)</h2>
<div class="text-xs text-gray-500">Clique em Win/Loss para marcar o dia.</div>
</div>
<div class="overflow-auto max-h-[50vh]">
<table class="w-full text-sm">
<thead>
<tr class="sticky-th">
<th class="text-left p-2">Dia</th>
<th class="text-left p-2">Data</th>
<th class="text-right p-2">Banca Início</th>
<th class="text-right p-2">Stop-loss</th>
<th class="text-right p-2">Stop-win</th>
<th class="text-right p-2">Banca Final</th>
<th class="text-center p-2">Win</th>
<th class="text-center p-2">Loss</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</section>

<footer class="text-xs text-gray-500 mt-6">
<p>Disciplina recomendada: atingir <span class="num">stop-win</span> e encerrar; respeitar <span class="num">stop-loss</span> diário.</p>
</footer>
</main>

<script>
const fmt=n=>new Intl.NumberFormat('pt-MZ',{maximumFractionDigits:2}).format(n);
const fmtPct=n=>new Intl.NumberFormat('pt-MZ',{maximumFractionDigits:3}).format(n);

function daysInclusive(d1,d2){return Math.floor((d2-d1)/(1000*60*60*24))+1;}

function recalc(){
  const banca=Number(document.getElementById('banca').value);
  const meta=Number(document.getElementById('meta').value);
  const inicio=new Date(document.getElementById('inicio').value);
  const fim=new Date(document.getElementById('fim').value);
  const slPct=Number(document.getElementById('slPct').value)/100;
  const swPct=Number(document.getElementById('swPct').value)/100;

  if(!banca||!meta||isNaN(inicio)||isNaN(fim)||fim<inicio){alert('Verifique os parâmetros.');return;}

  const N=daysInclusive(inicio,fim);
  document.getElementById('dias').textContent=N;
  document.getElementById('periodo').textContent=`${inicio.toLocaleDateString('pt-PT')} → ${fim.toLocaleDateString('pt-PT')}`;

  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  let B=banca;

  for(let i=1;i<=N;i++){
    const d=new Date(inicio); d.setDate(inicio.getDate()+(i-1));

    const SL=B-B*slPct;
    const SW=B+B*swPct;
    const Bfim=B+(meta-B)/N;

    const tr=document.createElement('tr'); tr.dataset.index=i-1;
    const cells=[i,d.toLocaleDateString('pt-PT'),fmt(B),fmt(SL),fmt(SW),fmt(Bfim)];
    cells.forEach((c,idx)=>{
      const td=document.createElement('td');
      td.className='p-2 '+(idx>=2?'text-right num':'');
      td.textContent=c;
      tr.appendChild(td);
    });

    const winTd=document.createElement('td'); const winDiv=document.createElement('div');
    winDiv.className='clickable'; winDiv.textContent='Win';
    winDiv.addEventListener('click',()=>{ tr.classList.toggle('win'); tr.classList.remove('loss'); atualizarResumo(); });
    winTd.appendChild(winDiv); tr.appendChild(winTd);

    const lossTd=document.createElement('td'); const lossDiv=document.createElement('div');
    lossDiv.className='clickable'; lossDiv.textContent='Loss';
    lossDiv.addEventListener('click',()=>{ tr.classList.toggle('loss'); tr.classList.remove('win'); atualizarResumo(); });
    lossTd.appendChild(lossDiv); tr.appendChild(lossTd);

    tbody.appendChild(tr); B=Bfim;
  }

  window.__export={banca,meta,inicio,fim,N,slPct,swPct};
  atualizarResumo();
}

function atualizarResumo(){
  const tbody=document.getElementById('tbody');
  if(!tbody.firstChild) return;
  const primeiraLinha=tbody.firstChild;
  const B=Number(primeiraLinha.cells[2].textContent.replace(/\./g,''));
  const slPct=window.__export.slPct;
  const swPct=window.__export.swPct;

  let lucroDia=primeiraLinha.classList.contains('win')?B*swPct:(primeiraLinha.classList.contains('loss')?-B*slPct:0);

  document.getElementById('slValor').textContent=fmt(B*slPct);
  document.getElementById('swValor').textContent=fmt(B*swPct);

  let bancaAtual=B+lucroDia;
  const diasRestantes=window.__export.N-1;
  let crescimento=0;
  if(diasRestantes>0){ crescimento=Math.pow(window.__export.meta/bancaAtual,1/diasRestantes)-1; }
  document.getElementById('rPct').textContent=fmtPct(crescimento*100)+'%';
}

function exportCSV(){
  if(!window.__export) return;
  const tbody=document.getElementById('tbody');
  const lines=[['Dia','Data','Banca Inicio','Stop-loss','Stop-win','Banca Final']];
  for(let i=0;i<tbody.children.length;i++){
    const tr=tbody.children[i];
    const row=[];
    for(let j=0;j<6;j++) row.push(tr.cells[j].textContent);
    lines.push(row);
  }
  const csv=lines.map(a=>a.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='plano_diario.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

document.getElementById('recalcular').addEventListener('click',recalc);
document.getElementById('exportar').addEventListener('click',exportCSV);
document.getElementById('imprimir').addEventListener('click',()=>window.print());

recalc();
</script>
</body>
</html>
